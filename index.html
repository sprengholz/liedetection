<!DOCTYPE html>
<html>

<head>
    <title>Experiment</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="js/jspsych.js"></script>

    <script src="js/plugins/jspsych-html-button-response.js"></script>
    <script src="js/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="js/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="js/plugins/jspsych-external-html.js"></script>
    <script src="js/plugins/jspsych-fullscreen.js"></script>
    <script src="js/plugins/jspsych-instructions.js"></script>
    

    <script src="js/plugins/jspsych-vignette.js"></script>
    <script src="js/plugins/jspsych-chat.js"></script>
    <script src="js/plugins/jspsych-word-sequence.js"></script>
    <script src="js/plugins/jspsych-flyin.js"></script>
    <script src="js/plugins/jspsych-timer.js"></script>

    <script src="js/jquery.min.js"></script>
    <script src="js/lodash.js"></script>
    <script src="js/anime.min.js"></script>
    <script src="js/download.min.js"></script>

    <script src="js/jquery.terminal-2.0.1.min.js"></script>

    <link href="css/jquery.terminal-2.0.1.css" rel="stylesheet" type="text/css" />
    <link href="css/jspsych.css" rel="stylesheet" type="text/css" />
</head>

<body>
    <div id="versionOverlay" style="position:fixed; font-size: 12px; color: #aaa; font-family: 'Open Sans', 'Arial', sans-serif; border: 1px solid #aaa; border-radius: 5px; padding: 3px; margin: 3px;">V1.0.0<span id="groupOverlay"></span></div>
    <div id="alertOverlay">
        <span id="alertText"></span>
    </div>
    
    <div id = "investigator" style="display: none;">
        <svg style="height: 100%; align-content: center;" viewBox="0 -10 50 80" xmlns="http://www.w3.org/2000/svg">
            <g id="hat">
                <polygon id="hatTop" points="6,15 42,15 46,9 24,1 2,9" fill="none" stroke="black" />
                <polyline id="hatMiddle" points="6,15 6,18 42,18 42,15" fill="none" stroke="black" />
                <path id="hatShield" d="M6,18 Q 25 30 42 18" stroke="black" fill="transparent"/>
                <circle id="hatBadge" cx="24" cy="9" r="3" stroke="black" fill="transparent"/>
            </g>
            <polyline id="browLeft" points="10,26 20,28" fill="none" stroke="black" />
            <polyline id="browRight" points="28,28 38,28" fill="none" stroke="black" />
            <ellipse id="eyeLeft" cx="15" cy="34" rx="2" ry="2" />
            <ellipse id="eyeRight" cx="33" cy="34" rx="2" ry="2" />
            <path id="mouth" d="M19 50 Q 25 50 31 50" stroke="black" fill="transparent"/>
        </svg>
    
    </div>
    <div id="terminal"></div>
    <div id="experiment"></div>
</body>
<script>

    /*
     * Helpers
     */

    function load(element, file, callback) {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("GET", file, true);
        xmlhttp.onload = function () {
            if (xmlhttp.status === 200 || xmlhttp.status === 0) {
                element.innerHTML = xmlhttp.responseText;
                callback();
            }
        };
        xmlhttp.send();
    }

    function shuffle(array) {
        var j, x, i;
        for (i = array.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = array[i];
            array[i] = array[j];
            array[j] = x;
        }
        return array;
    }


    /*
     * Alert Overlay Management
     */

    function showAlert(message) {
        $('#alertOverlay').show();
        $('#alertText').text(message);
    }

    function clearAlerts() {
        $('#alertOverlay').hide();
    }



    var investigatorAnimationDuration = 500;

    function showInvestigator() {
        $('#investigator').show();
    }

    function showInvestigatorAnger() {

        var animation = anime.timeline({
            autoplay: true
        });
        animation
        .add({
            targets: "#browLeft",
            points: "10,27 20,29",
            duration: investigatorAnimationDuration,
            offset: 0
        })
        .add({
            targets: "#browRight",
            points: "28,29 38,27",
            duration: investigatorAnimationDuration,
            offset: 0
        })
        .add({
            targets: "#mouth",
            d: "M19 51 Q 25 48 31 49",
            duration: investigatorAnimationDuration,
            offset: 0
        })
    }

    function showInvestigatorNeutral() {
        
        var animation = anime.timeline({
            autoplay: true
        });
        animation
        .add({
            targets: "#browLeft",
            points: "10,26 20,28",
            duration: investigatorAnimationDuration,
            offset: 0
        })
        .add({
            targets: "#browRight",
            points: "28,28 38,28",
            duration: investigatorAnimationDuration,
            offset: 0
        })
        .add({
            targets: "#mouth",
            d: "M19 50 Q 25 50 31 50",
            duration: investigatorAnimationDuration,
            offset: 0
        });
    }

    function showInvestigatorAffirmation() {
        
        var animation = anime.timeline({
            autoplay: true
        });
        animation
        .add({
            targets: "#eyeLeft",
            ry: "1",
            duration: investigatorAnimationDuration/4,
            offset: investigatorAnimationDuration/4
        })
        .add({
            targets: "#eyeRight",
            ry: "1",
            duration: investigatorAnimationDuration/4,
            offset: investigatorAnimationDuration/4
        })
        .add({
            targets: "#mouth",
            duration: investigatorAnimationDuration,
            d: "M19 50 Q 25 51 31 49", 
            offset: 0
        })
        .add({
            targets: "#eyeLeft",
            ry: "2",
            duration: investigatorAnimationDuration,
            offset: investigatorAnimationDuration/2,
            duration: investigatorAnimationDuration/4
        })
        .add({
            targets: "#eyeRight",
            ry: "2",
            duration: investigatorAnimationDuration,
            offset: investigatorAnimationDuration/2,
            duration: investigatorAnimationDuration/4
        })
        .add({
            targets: "#mouth",
            d: "M19 50 Q 25 50 31 50",
            duration: investigatorAnimationDuration,
            offset: investigatorAnimationDuration
        });
    }

    function hideInvestigator() {
        $('#investigator').hide();
    }



    /*
     * Global Variables
     */

    // key
    key_truth = 75
    key_lie = 68

    // control group (0) or hacking group (1)
    var group = Math.round(Math.random()); 
    $('#groupOverlay').text(" - G"+group);

    // demographics
    var age;
    var sex;

    // critical information
    var hackingHour;

    // questions
    var questions_critical = [
        'Sind Sie für den Hack verantwortlich?',
        'Was haben Sie zur Tatzeit gemacht?',
        'Welche Dokumente haben Sie gestohlen?',
        'Welche Institute haben Sie bestohlen?',
        'Welches Werkzeug haben Sie beim Hack verwendet?'
    ];

    var questions_uncritical = [
        'Wie alt sind Sie?',
        'Wo wohnen Sie?',
        'Seit wann studieren Sie in Jena?',
        'Was studieren Sie?',
        'Arbeiten Sie als Hilfskraft an der Uni?'
    ];

    // materials
    var documents = [
        'Klausuren',
        'Lohnscheine'
    ];

    var tools = [
        'Aircrack',
        'Medusa'
    ];

    var subjects = [
        'Bioinformatik',
        'Philosophie'
    ];

    var files = [
        'Bioinformatik/Klausur_Algorithmen.pdf',
        'Bioinformatik/Klausur_Softwareentwicklung.pdf',
        'Bioinformatik/Lohnschein_Arndt.pdf',
        'Bioinformatik/Lohnschein_Mueller.pdf',
        'Philosophie/Klausur_Erkenntnistheorie.pdf',
        'Philosophie/Klausur_Logik.pdf',
        'Philosophie/Lohnschein_Krumbolz.pdf',
        'Philosophie/Lohnschein_Meixner.pdf'
    ]

    // timeline
    var timeline = [];

    // press text
    var presstext = '<div class="presstext">Kürzlich wurde ein Server der Universität Jena gehackt. Die Täter erhielten unter anderem Zugriff auf Klausuren und Lohnscheine, vor allem die Institute für Bioinformatik und Philosophie sind betroffen. Der Server war gesichert, der Schutz entsprach allerdings nicht dem aktuellen Stand der Technik. So konnten sich die Angreifer mit vergleichsweise einfachen Mitteln Zutritt verschaffen. Für den Angriff wurden offenbar die Programme Aircrack und Medusa eingesetzt, zwei unter Hackern weit verbreitete Werkzeuge.</div>';
    
    /*
     * Setup Tasks for RT experiment 
     */

    var tasks = [];

    for (i = 0; i < questions_critical.length; i++) {
        for (j = 0; j < 5; j++) {
            task = {
                question: questions_critical[i],
                critical: true,
                target: "ehrlich"
            };
            tasks.push(task);
            task = {
                question: questions_critical[i],
                critical: true,
                target: "gelogen"
            };
            tasks.push(task);
        }
    }

    for (i = 0; i < questions_uncritical.length; i++) {
        for (j = 0; j < 5; j++) {
            task = {
                question: questions_uncritical[i],
                critical: true,
                target: "ehrlich",
            };
            tasks.push(task);
            task = {
                question: questions_uncritical[i],
                critical: true,
                target: "gelogen",
            };
            tasks.push(task);
        }
    }

    // create 20 tutorial tasks from matching stimuli

    var tutorialTasks = tasks.slice();
    tutorialTasks = shuffle(tasks);
    tutorialTasks = tutorialTasks.slice(0,20);

    // shuffle items
    tasks = shuffle(tasks);

    // add tutorial items at the beginning
    tasks = tutorialTasks.concat(tasks);
    
    
    /*
     * Show welcome screen
     */

    var welcome = {
        type: 'html-button-response',
        choices: ["Weiter"],
        stimulus: '<div class="instruction" style="max-width: 600px; margin-top: 110px;"><div class="heading">Hi</div><div class="smalltext"> Vielen Dank für dein Interesse an der vorliegenden Studie. Im Falle einer Teilnahme sollst du verschiedene Aufgaben am <strong>PC oder Notebook</strong> bearbeiten. Hierfür benötigst du eine richtige Tastatur - Tablets oder Smartphones sind also nicht geeignet. Das Ganze wird etwa <strong>45 Minuten</strong> dauern.</div><div class="smalltext">Die Teilnahme an der Studie hat keine bekannten Risiken. Alle gesammelten Daten werden <strong>anonym</strong> ausgewertet, ausschließlich für nicht-kommerzielle Zwecke im Rahmen wissenschaftlicher Forschung verwendet und nicht an Dritte weitergegeben. Eine nachträgliche Identifizierung deiner Daten ist nicht möglich (Privacy by Design, §25 DSGVO). Rückfragen zum Datenschutz können an die Datenschutzbeauftragte der Universität gerichtet werden:</div><div class="smalltext">Stefanie Buchmann<br>+49 3641 931087<br>stefanie.buchmann@uni-jena.de</div><div class="smalltext">Du kannst die Bearbeitung zu jeder Zeit und ohne Angabe von Gründen beenden. Bitte beachte, dass dir bei einem Abbruch aus technischen Gründen keine Versuchspersonenstunde ausgestellt werden kann. Diese erhältst du nach Abschluss des Experiments.</div><div class="smalltext">Wenn du Fragen zur Studie hast oder an den Ergebnissen interessiert bist, sende bitte eine E-Mail an:<div><div class="smalltext">Philipp Sprengholz<br>FSU Jena, Institut für Psychologie<br>philipp.sprengholz@uni-jena.de</div><div class="smalltext"><strong>Durch Klicken des folgenden Buttons bestätigst du, dass du alle Informationen gelesen und verstanden hast und an der Studie teilnehmen möchtest.</strong></div></div>'
    };
    timeline.push(welcome);



    /*
     * Show experiment summary
     */

    var experiment_summary = {
        type: 'html-button-response',
        choices: ["Weiter"],
        stimulus: '<div class="instruction-tac"><div class="heading">Zum Ablauf</div> <div class="smalltext">Du wirst dich zunächst kurz mit der Webseite der Universität Jena beschäftigen. Anschließend folgen einige Reaktionszeitaufgaben, in denen du besonders schnell auf bestimmte Wörter reagieren musst.</div></div>'
    };
    timeline.push(experiment_summary);


    /*
     * Ask for silent environment
     */

    var environment = {
        type: 'html-button-response',
        choices: ["Weiter"],
        stimulus: '<div class="instruction-tac"><div class="heading">Ruhe bitte</div><div class="smalltext"> Bitte achte darauf, dass du während der Teilnahme nicht abgelenkt wirst. Suche dir einen <strong>ruhigen Raum</strong> und lege dein Telefon außer Sichtweite. <div></div>'
    };
    timeline.push(environment);



    /*
     * Ask for Demographic Information
     */

    var demographics = {
        type: 'external-html',
        url: 'demographics.html',
        cont_btn: 'next',
        check_fn: function () {
            age = $('#age').val();

            if (/^([1-9][0-9])$/.test(age)) {
                sex = $('#sex').val();
                return true;
            } else {
                showAlert('Bitte gib dein korrektes Alter ein.');
                return false;
            }
        },
        on_finish: function (data) {
            clearAlerts();
            data.age = age;
            data.sex = sex;
            data.group = group;
        }
    };
    timeline.push(demographics);


    /*
     * Hacking or Web Research Task
     */

    var hacking = {
        type: 'external-html',
        url: 'hacking.html',
        cont_btn: 'next',
        check_fn: function () {
            var answersCorrect = true;

            var checkedTools = $("input[name='tools']:checked").map(function () {
                return this.value;
            }).get();
            if (!(checkedTools.includes('Aircrack') && checkedTools.includes('Medusa') && (checkedTools.length === 2))) {
                answersCorrect = false;
            }

            var checkedDocuments = $("input[name='documents']:checked").map(function () {
                return this.value;
            }).get();
            if (!(checkedDocuments.includes('Klausuren') && checkedDocuments.includes('Lohnscheine') && (checkedDocuments.length === 2))) {
                answersCorrect = false;
            }

            var checkedInstitutes = $("input[name='institutes']:checked").map(function () {
                return this.value;
            }).get();
            if (!(checkedInstitutes.includes('Bioinformatik') && checkedInstitutes.includes('Philosophie') && (checkedInstitutes.length === 2))) {
                answersCorrect = false;
            }

            if (answersCorrect) {
                return true;
            } else {
                showAlert('Bei einem erfolgreichen Hack sollten die Antworten anders ausfallen. Bitte prüfe deine Angaben.');
                return false;
            }
        },
        on_load: function (data) {


            // config terminal

            $('#terminal').show();

            var attacked = false;
            var connected = false;

            var getAddress = function () {
                $.when($('#terminal').terminal().read("Address: ")).done(function (address) {
                    if (address.toLowerCase().includes("uni-jena.de/login")) {
                        attack();
                    } else {
                        $('#terminal').terminal().echo("[[;#E45F5F;black]Target not found. Check address.]");
                        getAddress();
                    }
                });
            };

            var attack = function () {
                var terminal = $('#terminal').terminal();
                progressSign = ".";
                terminal.echo("Running brute force attack " + progressSign);
                terminal.pause();
                var i = 0,
                    interval = setInterval(function () {
                        terminal.update(-1, "Running brute force attack " + progressSign.repeat(i + 2));
                        i++;
                        if (i >= 15) {
                            terminal.update(-1, "[[;#96C47D;black]✔ Credentials found");
                            terminal.echo("Username: admin");
                            terminal.echo("Password: **********");
                            clearInterval(interval);
                            terminal.resume();
                            attacked = true;
                        }
                    }, 300);
            };

            var connect = function () {
                var terminal = $('#terminal').terminal();
                progressSign = ".";
                terminal.echo("Retrieving server content " + progressSign);
                terminal.pause();
                var i = 0,
                    interval = setInterval(function () {
                        terminal.update(-1, "Retrieving server content " + progressSign.repeat(i + 2));
                        i++;
                        if (i >= 15) {
                            terminal.update(-1, "[[;#96C47D;black]✔ Retrieval finished");
                            terminal.echo("----------------------------------------------");
                            terminal.echo("Folder               Files       Last accessed");
                            terminal.echo("----------------------------------------------");
                            terminal.echo("+ "+("Bioinformatik").padEnd(15, " ")+"    0             13 days ago");
                            terminal.echo("+ "+("Philosophie").padEnd(15, " ")+"    0             18 days ago");
                            terminal.echo("----------------------------------------------");
                            clearInterval(interval);
                            terminal.resume();
                            connected = true;
                        }
                    }, 300);
            };

            jQuery(function ($, undefined) {
                $('#terminal').terminal(
                    function (command) {
                        if (command.toLowerCase() === ("Aircrack").toLowerCase()) {
                            getAddress();
                        }
                        else if (command.toLowerCase() === ("Medusa").toLowerCase()) {
                            if (attacked) {
                                connect();
                            } else {
                                this.echo('[[;#E45F5F;black]Credentials missing. Run Aircrack first.]');
                            }
                        }
                        else if (command.toLowerCase().replace(/\s/g, "") === 'openbioinformatik') {

                            filesToShow = []
                            for (file of files) {
                                if (file.includes("Bioinformatik")) {
                                    filesToShow.push(file);
                                }
                            }

                            this.echo("----------------------------------------------");
                            this.echo("Folder Bioinformatik contains "+filesToShow.length+" files");
                            this.echo("----------------------------------------------");

                            for (file of filesToShow) {
                                filename = file.substring(file.indexOf('/')+1);
                                this.echo("<a href='files/"+file+"' style='color: #ffff8b;' target='_blank'>"+filename.padEnd(46, " ")+"</a>", { "raw": true });
                            }

                            this.echo("----------------------------------------------");

                        }
                        else if (command.toLowerCase().replace(/\s/g, "") === 'openphilosophie') {

                            filesToShow = []
                            for (file of files) {
                                if (file.includes("Philosophie")) {
                                    filesToShow.push(file);
                                }
        
                            }

                            this.echo("----------------------------------------------");
                            this.echo("Folder Philosophie contains "+filesToShow.length+" files");
                            this.echo("----------------------------------------------");

                            for (file of filesToShow) {
                                filename = file.substring(file.indexOf('/')+1);
                                this.echo("<a href='files/"+file+"' style='color: #ffff8b;' target='_blank'>"+filename.padEnd(46, " ")+"</a>", { "raw": true });
                            }

                            this.echo("----------------------------------------------");

                        }
                        else {
                            this.echo("[[;#E45F5F;black]Error. Please check command.]");
                        }
                    }, {
                        greetings: "[[b;#aaa;black]REMOTE ACCESS CONSOLE]",
                        name: 'hacking',
                        prompt: '> ',
                        convertLinks: false
                    });
            });

        },
        on_finish: function (data) {
            $('#terminal').hide();
            clearAlerts();
        }
    };

    /*
     * Attention Likert
     */

    var webresearchAnswers = [];

    var webresearch = {
        type: 'external-html',
        url: "webresearch.html",
        cont_btn: "next",
        check_fn: function () {
            webresearchAnswers = $("input:checked").map(function () {
                return $(this).val();
            }).toArray();

            if (webresearchAnswers.length === 3) {
                return true;
            }
            else {
                showAlert('Bitte beantworte alle Items.', true);
                return false;
            }
        },
        on_finish: function (data) {
            data.answers = webresearchAnswers;
            clearAlerts();
        }
    };


    if (group == 0) {
        // control group: web research task
        timeline.push(webresearch);
    } else {
        // hacking group: hacking task
        timeline.push(hacking);
    }
    

    /*
     * Enter Fullscreen Mode
     */

    var fullscreen = {
        type: 'fullscreen',
        fullscreen_mode: true,
        message: '<div class="instruction-tac"><div class="heading">Wechsel in den Vollbildmodus</div><div class="smalltext">Super, du hast den ersten Teil des Experiments bereits abgeschlossen! Der nun folgende zweite Teil wird im Vollbildmodus ablaufen. Wenn du das Experiment vorzeitig abbrechen möchtest, kannst du den Vollbildmodus durch Drücken der Tasten <span class="keyButton">Esc</span> oder <span class="keyButton">F11</span> verlassen und das Browserfenster schließen. Bitte beachte, dass ich dir aus technischen Gründen nur dann eine Versuchspersonenstunde ausstellen kann, wenn du bis zum Ende des Experiments dabei bleibst.</div></div>',
        button_label: 'Alles klar'
    };
    timeline.push(fullscreen);


    /*
     * Show Information about Second Part
     */

    var sherlock_intro = {
        type: 'html-button-response',
        choices: ["Sherlock starten"],
        stimulus: '<div class="instruction-tac"><div class="heading">Achtung!</div><div class="smalltext">Vor wenigen Minuten kam es zu einem unbefugter Zugriff auf Daten der Universität. Ein Server wurde gehackt, sensible Dokumente wurden gestohlen. Neben einigen anderen Studierenden wurdest du als möglicher Hacker identifiziert.</div><div class="smalltext">Alle Verdächtigen sollen nun einem Test durch ein neuartiges Ermittlungsprogramm namens <strong>Sherlock</strong> unterzogen werden, welches schuldige Person der Tat überführen kann. Auch du wirst gebeten, im Folgenden daran teilzunehmen.</div><div class="smalltext"><strong>Falls du etwas mit dem Hack zu tun hast, solltest du dich so unschuldig wie möglich präsentieren und auf kritische Fragen lieber lügen.</strong></div></div>'
    };
    timeline.push(sherlock_intro);


    /*
     * Presentation of Nonsecret (Public) Crime Information
     */

    var sherlock_welcome = {
        type: 'html-button-response',
        choices: ["Weiter"],
        stimulus: '<div class="rteInstructionContainer" style="min-height: 0; padding-top: 0;"><div class="instruction"><div class="smalltext-ms"><strong>Guten Tag.</strong></div><div class="smalltext-ms">Mein Name ist Sherlock. Ich bin ein Programm, das zur Untersuchung von Straftaten eingesetzt wird. Ich werde Ihnen zunächst einige Fragen stellen und anschließend überprüfen, ob Sie mich belogen haben.</div></div></div>',
        on_load: function(){
            showInvestigator();
        }
    };
    timeline.push(sherlock_welcome);


    /*
     * Investigation Chat
     */

    var chat = {
        type: 'chat',
        conversation: function () {
            conv = [
                {
                    person: 'Ermittler',
                    text: 'Lassen Sie uns direkt beginnen.'
                },
                {
                    person: 'Ermittler',
                    text: questions_uncritical[0]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Ok.'
                },
                {
                    person: 'Ermittler',
                    text: questions_uncritical[1]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Alles klar.'
                },
                {
                    person: 'Ermittler',
                    text: questions_uncritical[2]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Aha.'
                },
                {
                    person: 'Ermittler',
                    text: questions_uncritical[3]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Ok.'
                },
                {
                    person: 'Ermittler',
                    text: questions_uncritical[4]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Kommen wir zur Tat.'
                },
                {
                    person: 'Ermittler',
                    text: questions_critical[0]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Da bin ich mir nicht sicher.'
                },
                {
                    person: 'Ermittler',
                    text: questions_critical[1]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Hm...'
                },
                {
                    person: 'Ermittler',
                    text: questions_critical[2]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Alles klar.'
                },
                {
                    person: 'Ermittler',
                    text: questions_critical[3]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Ok. Letzte Frage:'
                },
                {
                    person: 'Ermittler',
                    text: questions_critical[4]
                },
                {
                    person: 'Subject',
                    evaluate_answer: false,
                    message: 'Danke. Sie werden nun zur nächsten Aufgabe weitergeleitet.'
                }
            ];
            return conv;
        },

        on_finish: function (data) { }
    };
    timeline.push(chat);


    /*
     * Reaction Time Experiment Elements
     */

    var blank = {
        type: 'html-keyboard-response',
        stimulus: '',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1000,
        data: { rte_part: 'blank' }
    };


    var fixation = {
        type: 'html-keyboard-response',
        stimulus: '<div class="fixation">+</div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 400,
        data: { rte_part: 'fixation' },
        on_load: function() {
            showInvestigatorNeutral(); 
        }
    };


    var question = {
        type: 'timer',
        stimulus: function(){
            return '<div class="question">'+jsPsych.timelineVariable('question')()+'</div>';
        },
        duration: function(){
            var min = 1000; //250 + jsPsych.timelineVariable('question')().length * 10;
            var max = 1000;
            return Math.random() < 0.5 ? min : max;
        }, 
        data: { rte_part: 'question' }
    };


    var target = {
        type: 'html-keyboard-response',
        stimulus: function () {
            stimulus = jsPsych.timelineVariable('target')();
            text = ""
            if (stimulus == "ehrlich") {
                text = shuffle(["e%hr#li&ch$", "e&hr+li$ch&", "e§hr?li#ch+", "e$hr&li+ch#", "&eh#rl%ic?h$", "&e#hr%li?ch&", "#e?hr$li#ch$", "$e&hr#li?ch§", "+#e%hr$li&ch§", "%&e+hr$li?ch$"])[0];
            } else {
                text = shuffle(["g%el#og&en$", "g&el+og$en&", "g§el?og#en+", "g$el&og+en#", "&ge#lo%ge?n$", "&g#el%og?en&", "#g?el$og#en$", "$g&el#og?en§", "+#g%el$og&en§", "%&g+el$og?en$"])[0];
            }
            
            html = '<div class="target">' + text + '</div>';
            
            return html;
        },
        trial_duration: 1500,
        choices: [key_truth, key_lie],
        data: { 
            rte_part: 'target'
        },
        on_load: function () {
            //
        },
        on_finish: function(data){
            data.question = jsPsych.timelineVariable('question')();
            data.target = jsPsych.timelineVariable('target')();
            if ((data.key_press == key_truth && data.target == "ehrlich") || (data.key_press == key_lie && data.target == "gelogen")){
                data.correct = true;
            } else {
                data.correct = false;
            }
            if (data.rt != null){
                data.intime = true;
            } else {
                data.intime = false;
            }
            console.log(data);
        }
    };


    var target_error = {
        type: 'html-keyboard-response',
        stimulus: function () {

            //secrecy = jsPsych.data.get().last(1).values()[0].trial_secrecy;
            //target = jsPsych.data.get().last(1).values()[0].trial_target;
            intime = jsPsych.data.get().last(1).values()[0].intime;
            if (intime) {
                return '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms"><strong>Verdächtig!</strong> Sie haben die falsche Taste gedrückt. Drücken Sie so schnell wie möglich <span class="keyButton">K</span> wenn das Wort <strong>ehrlich</strong> erscheint und <span class="keyButton">D</span> wenn das Wort <strong>gelogen</strong> erscheint.</div><div class="smalltext-ms">Drücken Sie die <span class="keyButton">Leertaste</span> um mit der nächsten Frage fortzufahren.</div></div></div>';
            } else {
                return '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms"><strong>Verdächtig!</strong> Sie waren zu langsam. Drücken Sie so schnell wie möglich <span class="keyButton">K</span> wenn das Wort <strong>ehrlich</strong> erscheint und <span class="keyButton">D</span> wenn das Wort <strong>gelogen</strong> erscheint.</div><div class="smalltext-ms">Drücken Sie die <span class="keyButton">Leertaste</span> um mit der nächsten Frage fortzufahren.</div></div></div>';
            }  
        },
        choices: [32],
        data: { rte_part: 'target_error' },
        on_load: function () {
            //
        },
        on_finish: function () {
            //
        }
    };


    var if_target_error = {
        timeline: [target_error],
        conditional_function: function () {

            correct = jsPsych.data.get().last(1).values()[0].correct;
            console.log("ERGEBNIS: "+correct);
            if (correct) {
                showInvestigatorAffirmation();
                return false;
            } else {
                showInvestigatorAnger();
                return true;
            }
        }
    };


    var attention_check_type;
    var questions;

    var attention_check = {
        type: 'html-keyboard-response',
        stimulus: function () {
            // case 1: check target word
            if (attention_check_type === 'target') {
                stim = '';
                stim += '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms"><strong>Welches Wort wurde zuletzt gezeigt?</strong> Drücken Sie eine der Tasten <span class="keyButton">1</span> oder <span class="keyButton">2</span> um das zuletzt gezeigte Wort auszuwählen.</div>';
                stim += '<div class="rteAttentionCheckChoiceBlock">';
                stim += '<div class="rteAttentionCheckChoice"><span class="keyButton">1</span><span class="rteAttentionCheckChoiceText">ehrlich</span></div>';
                stim += '<div class="rteAttentionCheckChoice"><span class="keyButton">2</span><span class="rteAttentionCheckChoiceText">gelogen</span></div>';
                stim += '<div></div></div>';
                return stim;
            }
            // case 2: check question prime
            if (attention_check_type === 'question') {

                lastQuestion = jsPsych.timelineVariable('question')();
                var otherQuestions = questions_critical.slice();
                otherQuestions = otherQuestions.concat(questions_critical);

                for (i = 0; i < otherQuestions.length; i++) {
                    if (otherQuestions[i] === lastQuestion) {
                        otherQuestions.splice(i, 1);
                        break;
                    }
                }

                questions = [];
                questions.push(lastQuestion);
                otherQuestions = otherQuestions.sort(() => .5 - Math.random());
                questions = questions.concat(otherQuestions.slice(0, 2));
                questions = questions.sort(() => .5 - Math.random());

                stim = '';
                stim += '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms"><strong>Welche Frage wurde Ihnen zuletzt gestellt?</strong> Drücken Sie eine der Tasten <span class="keyButton">1</span> bis <span class="keyButton">3</span> um die zuletzt gezeigte Frage auszuwählen.</div>';
                stim += '<div class="rteAttentionCheckChoiceBlock">';
                for (i = 0; i < questions.length; i++) {
                    stim += '<div class="rteAttentionCheckChoice"><span class="keyButton">' + (i + 1) + '</span><span class="rteAttentionCheckChoiceText">' + questions[i] + '</span></div>';
                }
                stim += '<div></div></div>';
                return stim;
            }
        },
        choices: function () {
            // case 1: options 1/2 for targets, 1/2/3 for questions
            if (attention_check_type === 'target') { return ['1', '2'] } else { return ['1', '2', '3'] }
        },
        data: { rte_part: 'attention_check' },
        on_load: function () { },
        on_finish: function (data) {
            if (attention_check_type === 'target') {

                var targetIdentified = false;
                lastTarget = jsPsych.timelineVariable('target')();

                if ((data.key_press == 49 && lastTarget == "ehrlich") || (data.key_press == 50 && lastTarget == "gelogen")){
                    targetIdentified = true;
                } else {
                    targetIdentified = false;
                }

                data.check_against = attention_check_type;
                data.check_stimulusToIdentify = lastTarget;
                data.check_correct = targetIdentified;
            }
            if (attention_check_type === 'question') {

                questionIdentified = false;
                lastQuestion = jsPsych.timelineVariable('question')();
                if (questions[data.key_press - 49] === lastQuestion) {
                    questionIdentified = true;
                }

                data.check_against = attention_check_type;
                data.check_stimulusToIdentify = lastQuestion;
                data.check_correct = questionIdentified;
            }
        }
    };


    var if_attention_check = {
        timeline: [attention_check],
        conditional_function: function () {
            
            lastPart = jsPsych.data.get().last(1).values()[0].rte_part;
            if (lastPart !== 'target_error') {
                chance = 0.1;
                if (Math.random() < chance) {
                    // 50/50 chance to check question prime or target word
                    if (Math.random() < 0.5) {
                        attention_check_type = 'question';
                    } else {
                        attention_check_type = 'target';
                    }
                    return true;
                } else {
                    return false;
                }
            } else {
                return false;
            }
        }
    };


    var attention_check_error = {
        type: 'html-keyboard-response',
        stimulus: function () {

            
            var errorMessage;
            if (attention_check_type === 'question') {
                errorMessage = 'Die von Ihnen gewählte Frage wurde nicht zuletzt gestellt. Achten Sie in Zukunft besser auf die gezeigten Fragen und Wörter - andernfalls machen Sie sich verdächtig!';
            }
            if (attention_check_type === 'target') {
                errorMessage = 'Das von Ihnen gewählte Wort wurde nicht zuletzt gezeigt. Achten Sie in Zukunft besser auf die gezeigten Fragen und Wörter - andernfalls machen Sie sich verdächtig!';
            }
            return '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms"><strong>Falsch!</strong> ' + errorMessage + '</div><div class="smalltext-ms">Drücken Sie die <span class="keyButton">Leertaste</span> um mit der nächsten Frage fortzufahren.</div></div></div>';
        },
        choices: [32],
        data: { rte_part: 'prime_check_error' },
        on_finish: function () {
            $('body').css('background-color', '#fff');
        }
    };


    var if_attention_check_error = {
        timeline: [attention_check_error],
        conditional_function: function () {

            // start error trial if subject's selection was wrong
            data = jsPsych.data.get().last(1).values()[0];
            if (data.rte_part === 'attention_check') {
                if (data.check_correct) {
                    showInvestigatorAffirmation();
                    return false;
                } else {
                    showInvestigatorAnger();
                    return true;
                }
            } else {
                return false;
            }
        }
    };


    var rte_instruction = {
        type: 'external-html',
        url: "rte_instruction.html",
        cont_btn: "next",
        check_fn: function () {

            //var count = $('input[type=checkbox][value="correct"]:checked').length;
            
            //console.log(count);

            //if (count == 2){
                return true;
            //} else {
            //    showAlert('Ihre Auswahl ist nicht korrekt. Bitte prüfen Sie Ihre Antworten.');
            //    return false;
            //}

        },
        data: { 
            rte_part: 'rte_instruction'
        },
        on_load: function (data) {
            showInvestigator();
        },
        on_finish: function (data) {
            clearAlerts();
        }
    };
    timeline.push(rte_instruction);


    var rte_start = {
        type: 'html-keyboard-response',
        stimulus: '<div class="rteInstructionContainer"><div class="instruction"><div class="smalltext-ms">Denken Sie daran, immer dann <span class="keyButton">K</span> zu drücken, wenn das Wort <strong>ehrlich</strong> nach einer Frage erscheint und <span class="keyButton">D</span> wenn das Wort <strong>gelogen</strong> gezeigt wird. Wenn Sie bereit sind, positionieren Sie jetzt Ihre Zeigefinger auf den beiden Tasten. Das Ganze wird etwa 15 Minuten dauern. Stellen Sie sicher, dass Sie in dieser Zeit nicht gestört werden.</div><div class="smalltext-ms">Drücken Sie mit dem Daumen die <span class="keyButton">Leertaste</span> um zu beginnen.</div></div></div>',
        choices: [32],
        data: { 
            rte_part: 'rte_pt2_start'
        },
        on_load: function () {
            $('body').css('cursor', 'none');
            $('#experiment').focus();
        }
    };
    timeline.push(rte_start);


    var rte = {
        timeline: [blank, fixation, question, target, if_target_error, if_attention_check, if_attention_check_error],
        timeline_variables: tasks,
        randomize_order: false
    };
    timeline.push(rte);



    /*
     * Attention Likert
     */

    var attentionAnswers = [];

    var attention = {
        type: 'external-html',
        url: "attention.html",
        cont_btn: "next",
        check_fn: function () {
            attentionAnswers = $("input:checked").map(function () {
                return $(this).val();
            }).toArray();

            if (attentionAnswers.length === 6) {
                return true;
            }
            else {
                showAlert('Bitte beantworte alle Items.', true);
                return false;
            }
        },
        on_load: function () {
            $('#experiment').css('cursor', 'default');
            hideInvestigator();
        },
        on_finish: function (data) {
            data.answers = attentionAnswers;
            clearAlerts();
        }
    };
    timeline.push(attention);


    /*
     * Debriefing
     */

    var debriefing = {
        type: 'html-keyboard-response',
        stimulus: function() {
            if (group == 0) {
                // control group debriefing
                return '<div class="instruction-tac"><div class="heading">Geschafft!</div><div class="smalltext">Vielen Dank für deine Teilnahme. Du hast mir sehr geholfen.</div><div class="smalltext" id="uploadinfo">Deine Angaben werden nun anonymisiert und verschlüsselt übertragen. Dies kann bis zu einer Minute dauern. Bitte warte...</div><img id="uploadimage" src="img/spinner.gif" alt="Übertragung läuft"><div class="smalltext" id="particitext"></div><div class="smalltext" id="particicode"></div><button class="navbutton" type="button" id="downloadbutton" style="display: none;" onclick="triggerDataDownload();">Daten speichern</button><div class="smalltext" id="finishtext" style="display: none;">Du kannst den Vollbildmodus durch Drücken der Tasten <span class="keyButton">Esc</span> oder <span class="keyButton">F11</span> verlassen und das Browserfenster dann einfach schließen.<br>Falls du Interesse an den Forschungsergebnissen und dem untersuchten Paradigma zur Aufdeckung von Täterwissen hast, kannst du weitere Informationen gern per E-Mail erfragen.</b></div></div>';
            } else {
                // hacking group debriefing
                return '<div class="instruction-tac"><div class="heading">Geschafft!</div><div class="smalltext">Vielen Dank für deine Teilnahme. Du hast mir sehr geholfen.</div><div class="smalltext" id="uploadinfo">Deine Angaben werden nun anonymisiert und verschlüsselt übertragen. Dies kann bis zu einer Minute dauern. Bitte warte...</div><img id="uploadimage" src="img/spinner.gif" alt="Übertragung läuft"><div class="smalltext" id="particitext"></div><div class="smalltext" id="particicode"></div><button class="navbutton" type="button" id="downloadbutton" style="display: none;" onclick="triggerDataDownload();">Daten speichern</button><div class="smalltext" id="finishtext" style="display: none;">Du kannst den Vollbildmodus durch Drücken der Tasten <span class="keyButton">Esc</span> oder <span class="keyButton">F11</span> verlassen und das Browserfenster dann einfach schließen.<br><b>Bitte beachte, dass dein Hacking-Angriff nur simuliert wurde und die heruntergeladenen Dokumenten nicht echt waren. Falls du Interesse an den Forschungsergebnissen und dem untersuchten Paradigma zur Aufdeckung von Täterwissen hast, kannst du weitere Informationen gern per E-Mail erfragen.</b></div></div>';
            }
        }, 
        choices: jsPsych.NO_KEYS,
        on_load: function () {
            // wait 3s before upload for visualization purposes
            setTimeout(function () {
                $('#experiment').css('cursor', 'default');
                save(jsPsych.data.get().csv());
            }, 3000);
        }
    };
    timeline.push(debriefing);


    /*
     * Save Data Routine
     */

    function save(data) {
        // local url: http://localhost:8080/save
        // heroku url: https://rtebackend.herokuapp.com/save
        $.ajax({
            type: "POST",
            url: "https://rtebackend.herokuapp.com/save",
            data: data,
            contentType: 'text/plain',
            timeout: 60000
        }).done(function (response) {

            $('#experiment').css('cursor', 'default');

            var idcode = JSON.parse(response).result;
            if (idcode !== 'error') {
                saveSuccess(idcode);
            } else {
                saveFailure();
            }
        }).fail(function (response) {
            saveFailure();
        });
    }

    function saveSuccess(idcode) {
        $('#uploadinfo').text('Deine Daten wurden erfolgreich anonymisiert und verschlüsselt übertragen.');
        $('#uploadinfo').css('color', '#ffffff');
        $('#uploadinfo').css('background-color', '#51ca90');
        $('#uploadinfo').css('border-radius', '10px');

        $('#uploadimage').hide();

        $('#particitext').text('Du erhältst für deine Teilnahme 1 Versuchspersonenstunde. Bitte notiere auf deiner Testatkarte die Studie "Liar Detection 1" mit folgendem Teilnahmecode. Bitte notiere dir separat auch meine E-Mail-Adresse philipp.sprengholz@uni-jena.de. Sollte es bei der Anrechnung durch das Prüfungsamt zu Problemen kommen, kannst du mich so erreichen.');
        $('#particicode').text('AP2/LIARDETECTION1/'+idcode.substring(0,6));

        $('#finishtext').show();
    }

    function saveFailure() {
        $('#uploadinfo').text('Es trat ein Fehler beim Senden deiner Daten auf.');
        $('#uploadinfo').css('color', '#ffffff');
        $('#uploadinfo').css('background-color', '#ff6060');
        $('#uploadinfo').css('border-radius', '10px');

        $('#uploadimage').hide();

        $('#particitext').html('Wegen des Fehlers benötige ich deine Hilfe. Bitte speichere deine Daten über den folgenden Button und sende sie anschließend als E-Mail-Anhang an philipp.sprengholz@uni-jena.de. Solltest du die Bestätigung einer Versuchspersonenstunde wünschen, teile mir dies bitte auch in der E-Mail mit. Deine E-Mail-Adresse und alle weiteren Daten werden natürlich vertraulich behandelt.');
        $('#particicode').hide();

        $('#downloadbutton').show();
    }

    function triggerDataDownload() {
        download(jsPsych.data.get().csv(), "data.csv", "text/plain");
        $('#finishtext').show();
    }


    /*
     * Start Experiment
     */

    jsPsych.init({
        display_element: 'experiment',
        timeline: timeline,
        on_finish: function () {
            // for testing purposes: show experiment data at the end
            // jsPsych.data.displayData();
        }
    });

</script>

</html>